

# # ------------------------
# # Stage 1: Builder
# # ------------------------
# FROM node:20-bullseye AS builder

# RUN apt-get update && apt-get install -y \
#   python3 make g++ gcc postgresql-client \
#   && ln -sf python3 /usr/bin/python \
#   && rm -rf /var/lib/apt/lists/*

# RUN mkdir -p /usr/src/app && chown -R node:node /usr/src/app
# WORKDIR /usr/src/app
# USER node

# # Copy and install dependencies
# COPY --chown=node:node package*.json ./
# RUN npm ci

# # Setup npm global path
# RUN mkdir -p /home/node/.npm-global && \
#     npm config set prefix /home/node/.npm-global && \
#     echo 'export PATH=/home/node/.npm-global/bin:$PATH' >> /home/node/.bashrc
# ENV PATH=/home/node/.npm-global/bin:$PATH

# # Install Nest CLI globally
# RUN npm install -g @nestjs/cli

# # Copy source
# COPY --chown=node:node . .

# # Build the app
# RUN npm run build

# # ------------------------
# # Stage 2: Runtime
# # ------------------------
# FROM node:20-bullseye AS runtime

# RUN apt-get update && apt-get install -y \
#   python3 make g++ gcc postgresql-client \
#   && ln -sf python3 /usr/bin/python \
#   && rm -rf /var/lib/apt/lists/*

# RUN mkdir -p /usr/src/app && chown -R node:node /usr/src/app
# WORKDIR /usr/src/app
# USER node

# # Copy everything from builder
# COPY --from=builder --chown=node:node /usr/src/app/dist ./dist
# COPY --from=builder --chown=node:node /usr/src/app/node_modules ./node_modules
# COPY --from=builder --chown=node:node /usr/src/app/prisma ./prisma
# COPY --from=builder --chown=node:node /usr/src/app/package*.json ./

# # Set env vars
# ARG NODE_ENV=development
# ENV NODE_ENV=${NODE_ENV}
# EXPOSE 5000

# # Wait for Postgres before starting Prisma
# CMD bash -c '\
#   until pg_isready -h postgres_db -p 5432 -U postgres; do \
#     echo "‚è≥ Waiting for PostgreSQL..."; \
#     sleep 2; \
#   done; \
#   echo "üöÄ PostgreSQL is ready! Running migrations..."; \
#   npx prisma migrate deploy && \
#   echo "‚úÖ Starting NestJS..."; \
#   if [ "$NODE_ENV" = "production" ]; then \
#     node dist/main.js; \
#   else \
#     npm run start:dev; \
#   fi'



# ------------------------
# Development Dockerfile
# ------------------------
FROM node:20-bullseye

# Install dependencies
RUN apt-get update && apt-get install -y \
  python3 make g++ gcc postgresql-client \
  && ln -sf python3 /usr/bin/python \
  && rm -rf /var/lib/apt/lists/*

WORKDIR /usr/src/app

# Copy package.json first for caching
COPY package*.json ./

# Install dependencies
RUN npm ci

# Install ts-node-dev for hot reload
RUN npm install -g ts-node-dev

# Copy the rest of your source code
COPY . .

EXPOSE 5000

# Start the app with hot reload
CMD bash -c '\
  until pg_isready -h postgres_db -p 5432 -U postgres; do \
    echo "‚è≥ Waiting for PostgreSQL..."; \
    sleep 2; \
  done; \
  echo "üöÄ DB ready. Running Prisma generate..."; \
  npx prisma generate && \
  echo "‚úÖ Starting NestJS in development mode..."; \
  npx ts-node-dev --respawn --transpile-only src/main.ts'

